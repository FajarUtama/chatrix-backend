# Mosquitto ACL Configuration for Chatrix MQTT Chat System
# 
# This file defines access control for MQTT topics based on user authentication.
# Each user can only subscribe to their own inbox topics and publish receipts.
#
# Setup:
# 1. Place this file at /etc/mosquitto/acl (or path specified in mosquitto.conf)
# 2. In mosquitto.conf, add:
#    allow_anonymous false
#    password_file /etc/mosquitto/passwd
#    acl_file /etc/mosquitto/acl
#
# 3. Create password file:
#    mosquitto_passwd -c /etc/mosquitto/passwd user123
#    mosquitto_passwd /etc/mosquitto/passwd user456
#
# Note: Dynamic user IDs require either:
# - Pattern-based ACL (Mosquitto 2.0+) with user pattern matching
# - MQTT Gateway that handles authentication and topic routing
# - Per-user ACL entries (not scalable)

# ========================================
# APPROACH 1: Pattern-Based ACL (Mosquitto 2.0+)
# ========================================
# Use pattern %u to match authenticated username
# Format: user {mqtt_username}
# Topic patterns with %u are replaced with username

# Example user entries (user ID from authentication)
user user123
topic read chat/v1/users/user123/#
topic write chat/v1/receipts

user user456
topic read chat/v1/users/user456/#
topic write chat/v1/receipts

# Pattern for dynamic users (requires Mosquitto 2.0+)
# user %u
# topic read chat/v1/users/%u/#
# topic write chat/v1/receipts

# Deny all other topics
topic deny #

# ========================================
# APPROACH 2: MQTT Gateway (Recommended for Production)
# ========================================
# Instead of direct client connections to Mosquitto, use a gateway:
#
# 1. Clients connect to gateway with JWT token
# 2. Gateway validates JWT and extracts user ID
# 3. Gateway maintains MQTT connection to Mosquitto with fixed credentials
# 4. Gateway subscribes client to chat/v1/users/{userId}/# based on JWT user ID
# 5. Gateway publishes receipts from client to chat/v1/receipts
#
# Benefits:
# - Dynamic user IDs without ACL file updates
# - JWT validation at gateway level
# - Better security isolation
# - Easier to implement rate limiting and monitoring
#
# ACL for gateway:
user mqtt_gateway
topic readwrite chat/v1/#

# ========================================
# APPROACH 3: Shared Topic with Server Validation
# ========================================
# Allow all authenticated users to publish to shared receipt topic
# Server validates actor_user_id in payload
#
# ACL:
user %u
topic read chat/v1/users/%u/#
topic write chat/v1/receipts
topic deny #

# ========================================
# JWT Authentication Options
# ========================================
#
# Mosquitto doesn't natively support JWT. Options:
#
# 1. Custom Auth Plugin:
#    - Use mosquitto-auth-plug
#    - Configure JWT validation
#    - Extract user ID from JWT claims
#    - More complex setup but tighter integration
#
# 2. MQTT Gateway (Recommended):
#    - Implement gateway service
#    - Gateway handles JWT validation
#    - Gateway maps to MQTT broker
#    - Simpler and more flexible
#
# 3. Token-based Username:
#    - Client uses JWT as username (not recommended for security)
#    - Configure auth plugin to validate JWT
#    - Extract user ID from JWT for topic routing

# ========================================
# Example Gateway ACL
# ========================================
# If using gateway approach, gateway connects with fixed credentials:
#
# user gateway_user
# topic readwrite chat/v1/#
#
# Gateway then manages per-user subscriptions internally.



